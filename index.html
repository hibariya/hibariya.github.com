<!DOCTYPE html>
<html>
  <head>
    <title>Hi - Hibariya</title>
    <meta charset='utf-8'>
    <meta content='hibariya' name='author'>
    <link href='/favicon-f5e12bf5.png' rel='icon' type='image/png'>
    <link href='/articles.xml' rel='alternate' title='Atom' type='application/atom+xml'>
    <link href="stylesheets/application-458a848e.css" rel="stylesheet" type="text/css" media="all" />
    <script src="javascripts/application-5ad96b48.js" type="text/javascript"></script>
  </head>
  <body class='index'>
    <header>
      <h1>
        <a href="/">Hibariya</a>
      </h1>
      <nav>
        <ul id='menu'>
          <li><a href="/">Home</a></li>
          <li><a href="articles.html">Articles</a></li>
          <li><a target="_blank" href="https://github.com/hibariya">Github</a></li>
          <li><a target="_blank" href="https://twitter.com/hibariya">Twitter</a></li>
          <li><a target="_blank" href="https://hibariya.org">hibariya.org</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <div id='articles'>
        <article>
          <time>2017-04-29</time>
          <h1><a href="articles/20170429/trbmeetup.html">Tokyo Rubyist Meetup / 読んだ本</a></h1>
          <h2>Tokyo Rubyist Meetup で発表してきた</h2>
          
          <p><a href="https://trbmeetup.doorkeeper.jp/events/59184">4/19</a> の回で GraphQL について話してきた。「GraphQL は、Web API でありがちな諸問題への解決策のひとつとして良いもので、こんな感じで使います。」という内容。</p>
          
          <script async class="speakerdeck-embed" data-id="99920bda53c24c8bad73a579e16d144e" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>
          
          <p>Paul さんに発表しないかとメールで誘ってもらったのがきっかけ。その後、せっかくなので会場の提供も永和ですることになった。英語が下手でも問題ないか確認したところ「英語で発表したことがない人に登壇できる場所を提供したい」から大丈夫とのこと。</p>
          
          <p>準備のために大量の英文を書いた結果、思ったことをその場で文にするのがずっと楽になった。録音した自分の発音を確認する作業を繰り返したおかげか、聞き取れる程度には発音できるようになったらしい。とはいえ、まだ満足に会話できるレベルには色々足りなくて、発表後の質問タイムではいくつかの質問にうまく答えられなかった。これは次の機会までの課題になりそう。もうしばらくお勉強と実践を繰り返していくつもり。</p>
          
          <h2><a href="https://www.amazon.co.jp/gp/product/4150503761/ref=as_li_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=4150503761&amp;linkCode=as2&amp;tag=hibariya-22&amp;linkId=851ceafadf2a00561a4e2efc4508d0c7">これからの「正義」の話をしよう</a></h2>
          
          <p>これまで何となく「正しいだろう」と素通りしてきたことについて、新たな視点が得られたような。最後あたりの話はちょっと難しい。</p>
          
          <h2><a href="https://www.amazon.co.jp/gp/product/4560034966/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=hibariya-22&amp;camp=247&amp;creative=1211&amp;linkCode=as2&amp;creativeASIN=4560034966&amp;linkId=8bc1b17e0a89d44fbb62d47e9e15a64b">ゴドーを待ちながら</a></h2>
          
          <p>「ゴドーを待つんだ。」「ああそうか。」</p>
          
          <p>こういうの好きだ、と思いながらささっと読了。その時代の背景を知っているともっと面白く読めるんだろうかと発行年を調べたら1952年。第二次世界大戦が終わったり、太宰治が入水して数年後。</p>
        </article>
        <article>
          <time>2017-03-12</time>
          <h1><a href="articles/20170312/note.html">3月上旬のようす (ゆるデ部/GraphQL/How We Learn)</a></h1>
          <h2><a href="https://github.com/yurufuwa/meetups/issues/76">ゆるデ部 meetup 64回</a></h2>
          
          <p>前回で初参加して、今回が二回目。</p>
          
          <p>前回 <a href="https://github.com/hibariya/ashell">音の鳴るシェル</a> を作るために Pure Data で SE を作ってるんですがこういうのに使えるゲームの効果音みたいな素材ないんですかね、というようなことを言ったら <a href="http://osabisi.sakura.ne.jp/m2/">ザ・マッチメイカァズ</a> のようなまさに探していた感じの素材のありかを教えてもらう。「ダンジョンの壁に当たったとき」みたいな簡単な音を作るのさえけっこう手間だったので、ここで聞けてよかった。</p>
          
          <p>効果音が揃ったのでそれなりに楽しくなったものの、もう少し面白くできないかなあと思ってしばらくほったらかしにしてた状態で2回目に参加。ドラムとか使ったシンプルな BGM があって、シェルを操作したときの音をそれにうまく合わせられると気持ちいいんじゃないかと言われてなるほどと思う。音ゲー的な感じだろうか。似たコンセプトのゲームに Rez というのがあるらしい。PS4買ったらやってみようかなあ。</p>
          
          <h2>GraphQL</h2>
          
          <p>年始から少し気になっていた GraphQL がおもしろくて API の実装を試してみたりしている。何が必要かをクライアント側がクエリではっきり簡潔に記述できるのいいなあ。スキーマから最低限の API ドキュメントが生成できるのも助かる。あと GraphiQL べんり。いいとこたくさん。でもサーバ側の実装はそんなに簡単じゃないかも。</p>
          
          <p>作った API の使い心地を確認するために、いくつかクライアント側の実装も試してみた。Relay とか Apollo は色々やってくれて便利な反面、既にあるものを置き換えるにはそれなりに大きな変更が必要そうに見えた。その点 Lokka は単純な GraphQL のクライアントなので当たり前だけど自由度が高く、ちょっとした用途には使いやすかった。</p>
          
          <p>参考にしたサンプルアプリは webpack でビルドできるものが多くて、試しに自分でも使いはじめてみたところけっこう楽ができてる気がする。</p>
          
          <h2><a href="https://www.amazon.co.jp/gp/product/B0192JTW62/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=hibariya-22&amp;camp=247&amp;creative=1211&amp;linkCode=as2&amp;creativeASIN=B0192JTW62&amp;linkId=50b0bcb67717c7f65ed070f706c01720">脳が認める勉強法</a> (How We Learn) を読んだ</h2>
          
          <p>記憶力や創造性についての事実が発見されていくまでのストーリー。その過程で行なわれた数々の実験についても詳しめに書かれていて面白かった。記憶の謎を解明するために何の意味もないたくさんの文字列を家族全員で学習する話とか、レム睡眠が発見されたときのエピソードとか。</p>
          
          <p>学習の環境に変化をつけると何が変わるのか。学習前にテストを行なうことにはどれほどの意味があるか。アイデアの「孵化」はどのようにして起こるか。そんな感じのことが書いてある。巻末には TL;DR 的な Q&amp;A が載っていて、実践的な内容としてはその数ページを読めば十分かも。</p>
          
          <p>ここで読んだ孵化の話は <a href="https://www.amazon.co.jp/gp/product/4484881047/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;tag=hibariya-22&amp;camp=247&amp;creative=1211&amp;linkCode=as2&amp;creativeASIN=4484881047&amp;linkId=1ff9d48ea98825429a45694a377baa19">アイデアのつくり方</a> にもあった気がする。</p>
        </article>
        <article>
          <time>2017-02-19</time>
          <h1><a href="articles/20170219/shell-postexec.html">シェルでコマンドの実行前後をフックする</a></h1>
          <p>私達の使うアプリケーションは色々な音を出します。通知やエラーを知らせる効果音、たまにジングル (短かい音楽) を鳴らすものもあります。好みや事情によって無効にしている人も少なくないと思いますが、個人的には鳴らせるときには鳴らす方が好みです。なので、毎日使うアプリケーションのひとつであるシェルからも音が出ると楽しいのではないかと思います。例えば、コマンドを実行するときに効果音を出してみたり、失敗したとき (<code>$? -ne 0</code>) には悲しい感じの音が出るとか。もっと発展させて、状況に応じてリアルタイムにサウンドを作り出すとか。</p>
          
          <p>そんな「音の鳴るシェル」作りの一環として、今回はコマンド実行の前後で音を出す方法を考えてみます。どうすればコマンドを叩くタイミングで任意の処理を実行できるのでしょう。1年くらい前に <a href="http://note.hibariya.org/articles/20160118/pty-shell.html">シェルを操作する</a> 記事を書きました。この方法ではシェルの入出力を操作できますが、シェル上で実行されたコマンドの実行結果は得られません。そこで、シェルの機能を使ってコマンドの実行をフックし、コマンドの結果などを取得する方法を調べました。</p>
          
          <h2>fish</h2>
          
          <p>fish では <a href="http://fishshell.com/docs/current/index.html#event">イベントハンドラ</a> というかたちでコマンド実行前後の処理を実装できます。function 定義にイベントを指定しておくと、イベントが発火されたタイミングでその function が実行されます。この仕組みを利用してコマンド実行前後をフックするには、組込みの <code>fish_preexec</code> と <code>fish_postexec</code> イベントが使えます。</p>
          <pre class="highlight plaintext"><code>function my_preexec --on-event fish_preexec&#x000A;  echo "preexec: $argv[1]"&#x000A;end&#x000A;&#x000A;function my_postexec --on-event fish_postexec&#x000A;  echo "postexec: $argv[1] ($status)"&#x000A;end&#x000A;</code></pre>
          
          <p>実行してみましょう。</p>
          <pre class="highlight plaintext"><code>$ uname&#x000A;preexec: uname&#x000A;Linux&#x000A;postexec: uname (0)&#x000A;$ hi&#x000A;preexec: hi&#x000A;fish: Unknown command 'hi'&#x000A;postexec: hi (127)&#x000A;</code></pre>
          
          <p>ちなみに function 定義には <code>--on-variable</code> や <code>--on-signal</code> というオプションもあり、値の変化やシグナルの受信を監視できて便利そうです。</p>
          <pre class="highlight plaintext"><code>function my_pwd_changed --on-variable PWD&#x000A;  echo "PWD: $PWD"&#x000A;end&#x000A;&#x000A;function my_term_trap --on-signal SIGUSR1&#x000A;  echo "SIGUSR1 received"&#x000A;end&#x000A;</code></pre>
          
          <p>実行結果は次のようになります。</p>
          <pre class="highlight plaintext"><code>$ cd /tmp/&#x000A;PWD: /tmp&#x000A;$ kill -USR1 %self&#x000A;SIGUSR1 received&#x000A;</code></pre>
          
          <h2>zsh</h2>
          
          <p>zsh の場合は、<code>add-zsh-hook</code> でフックを登録できます。<code>fish_postexec</code> にあたるものは無いので、プロンプト表示前に実行される <code>precmd</code> を、コマンド実行後のフックとして代用しました。ここには実行したコマンドが渡ってくるわけではないので、もし必要ならばもう少し工夫が要りそうです。</p>
          <pre class="highlight shell"><code>autoload -Uz add-zsh-hook&#x000A;&#x000A;add-zsh-hook preexec my_preexec&#x000A;add-zsh-hook precmd my_precmd&#x000A;&#x000A;my_preexec<span class="o">()</span> <span class="o">{</span>&#x000A;  <span class="nb">echo</span> <span class="s2">"preexec: </span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span>&#x000A;<span class="o">}</span>&#x000A;&#x000A;my_precmd<span class="o">()</span> <span class="o">{</span>&#x000A;  <span class="nb">echo</span> <span class="s2">"precmd (</span><span class="k">${</span><span class="p">?</span><span class="k">}</span><span class="s2">)"</span>&#x000A;<span class="o">}</span>&#x000A;</code></pre>
          
          <p>実行結果です。</p>
          <pre class="highlight plaintext"><code>% uname&#x000A;preexec: uname&#x000A;Linux&#x000A;precmd (0)&#x000A;% hi&#x000A;preexec: hi&#x000A;zsh: command not found: hi&#x000A;precmd (127)&#x000A;</code></pre>
          
          <h2>bash</h2>
          
          <p>bash では <a href="https://github.com/rcaloras/bash-preexec"><code>bash-preexec</code></a> を使うと比較的簡単に実現できました。zsh と同様、コマンド実行後のフックは <code>precmd</code> で代用しています。実行結果は zsh の場合とほぼ同じなので省略します。</p>
          <pre class="highlight shell"><code><span class="c"># https://github.com/rcaloras/bash-preexec</span>&#x000A;<span class="nb">source</span> ./bash-preexec.sh&#x000A;&#x000A;preexec_functions+<span class="o">=(</span>my_preexec<span class="o">)</span>&#x000A;precmd_functions+<span class="o">=(</span>my_precmd<span class="o">)</span>&#x000A;&#x000A;my_preexec<span class="o">()</span> <span class="o">{</span>&#x000A;  <span class="nb">echo</span> <span class="s2">"preexec: </span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">"</span>&#x000A;<span class="o">}</span>&#x000A;&#x000A;my_precmd<span class="o">()</span> <span class="o">{</span>&#x000A;  <span class="nb">echo</span> <span class="s2">"precmd (</span><span class="nv">$?</span><span class="s2">)"</span>&#x000A;<span class="o">}</span>&#x000A;</code></pre>
          
          <h2>おわりに</h2>
          
          <p>私がよく使うシェルを対象に、コマンド実行前後をフックする方法について調べました。別の実現方法としては ptrace(2) や DTrace、trap(1) を駆使することで似たようなことができるかもしれません (試してない)。が、私の知っている範囲だとシェルを使うのが比較的シンプルなやり方だと思いました。もしもっと良いやり方があれば教えてください。</p>
        </article>
        <article>
          <time>2017-02-10</time>
          <h1><a href="articles/20170210/note.html">2月上旬の出来事</a></h1>
          <h2>普段使いのバッグを変えた</h2>
          
          <p>今までは <a href="https://www.amazon.co.jp/gp/product/B01DLS32P2/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B01DLS32P2&amp;linkCode=as2&amp;tag=hibariya-22">FJALL RAVEN KANKEN</a> の紺色+黄色のやつを使っていたんだけど、16Lだと少し心細い。PCとヘッドホンケースを入れたらあまりスペースに余裕がなくなってしまう感じ。</p>
          
          <p>新しいのは少し大きめにして <a href="https://www.amazon.co.jp/gp/product/B01BWLMDH8/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B01BWLMDH8&amp;linkCode=as2&amp;tag=hibariya-22">MILLET TARN 25</a> にした。これくらいの大きさだとちょと遠くへ行くにも安心感があっていい。それと、このバッグは上下2部屋に分けられるところがよくて、少し狭い下段の部屋には普段使わないが持っておきたい折り畳み傘とか電源ケーブルみたいなものを突っ込んでおける。</p>
          
          <p>今更だけど FJALL RAVEN は手提げで使うのが便利なのではという気がしてきた。だからこれからも何かと用途はありそう。よかったよかった。</p>
          
          <h2>hibariya.org の DNS を Cloudflare に移行した</h2>
          
          <p>Cloudflare も <a href="https://api.cloudflare.com/">API</a> を公開していたので、以前やったような <a href="http://note.hibariya.org/articles/20150525/zerigo-api.html">たまに変わるIPアドレスを更新する</a> ためのコードをガガガと書いた。プロセスの管理が面倒なので適当なスケジューラ (Systemd の timer) を使って、決まった時間に叩いている。Systemd の timer は cron に比べて設定が冗長で面倒だと思っていたけど、エラー含めた出力がデフォルトで journal に流れるのはいいな。というのと、こういう用途には実行可能なバイナリ形式が楽そうだなあと思った。</p>
          
          <h2>アボカドをハイドロカルチャーにした</h2>
          
          <p>アボカドの種を水につけて栽培していたんだけど、色々面倒になってきたので栽培方法をハイドロカルチャーに変えた。容器の底に <a href="https://www.amazon.co.jp/gp/product/B0091GFTB4/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B0091GFTB4&amp;linkCode=as2&amp;tag=hibariya-22">ミリオンA</a> と <a href="https://www.amazon.co.jp/gp/search/ref=as_li_qf_sp_sr_il_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;index=aps&amp;keywords=B00UFKAMD0&amp;linkCode=as2&amp;tag=hibariya-22">イオン交換樹脂剤</a> を入れて、 <a href="https://www.amazon.co.jp/gp/product/B00C0KG1OC/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=247&amp;creative=1211&amp;creativeASIN=B00C0KG1OC&amp;linkCode=as2&amp;tag=hibariya-22">ハイドロコーン</a> で種を固定したらできあがり。毎日水をかえなくてよくなったし、万一容器を倒してしまっても掃除が楽そう。</p>
          
          <p>ハイドロカルチャーというのは和製英語で、hydro (水) + culture (栽培) ということらしい。cultureに栽培や養殖という意味もあるというのを初めて知った。じゃあ単に水につけて栽培するのも魚の養殖もハイドロカルチャーなんだろうかという気がしてくるが、その辺はよくわからない。水で養殖してるわけじゃないんだから魚は言いすぎか。</p>
        </article>
        <article>
          <time>2017-02-03</time>
          <h1><a href="articles/20170203/emberjs-tokyo-reborn.html">Ember.js Tokyo Reborn へ行った</a></h1>
          <p>昨日 (2/2) の <a href="https://emberjs.doorkeeper.jp/events/56135">Ember.js Tokyo Reborn</a>。LT枠もあったので最近 Ember Data まわりの悩みごとについて発表してきました。</p>
          
          <script async class="speakerdeck-embed" data-id="396313f98d8d42ea87a3e98b10dd80a2" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>
          
          <p>何かを削除するアクションをしたとき、即座にサーバへ反映したいけど、そのアクションを起こしたクライアント上ではまだちょっと表示していたい。例えば Twitter の Like 一覧で Unlike してもしばらく残ってるみたいな動きを Ember + Ember Data でやるときに、もっとうまくやれないかなという内容です。</p>
          
          <p>会場では、直接の解決策ではないけど、<a href="https://pouchdb.com/">pouchdb</a> のようなものを使ってうまくやれないかとか、ちょっと違うかもだけど <a href="https://github.com/DockYard/ember-changeset">ember-changeset</a> 便利ですよという話を聞けた。便利そう。</p>
          
          <p>その他に気になった話題とか:</p>
          
          <ul>
          <li><code>Ember.computed.filterBy</code> が激重で困ってる。</li>
          <li>Ember.js のユニットテスト使うといいよ (そういえば使ってないな...)。</li>
          <li><a href="https://github.com/dopin/ember-tokyo-reborn">https://github.com/dopin/ember-tokyo-reborn</a></li>
          </ul>
          
          <p>近所の Ember ユーザの話を聞ける貴重な時間だったなあ。それとさくらインターネットさんのオフィスから見える夜景たいへんきれいでした。</p>
          
          <blockquote class="twitter-tweet" data-lang="en"><p lang="ja" dir="ltr">かわいい。 <a href="https://t.co/CXl72OGOt4">pic.twitter.com/CXl72OGOt4</a></p>&mdash; Hibariya (@hibariya) <a href="https://twitter.com/hibariya/status/827128229546782723">February 2, 2017</a></blockquote>
          
          <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
        </article>
      </div>
    </main>
  </body>
</html>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-64572851-1', 'auto');
  ga('send', 'pageview');
</script>

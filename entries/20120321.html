<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>2012-03-21 - Joy Luck Crab</title>
<meta content="hibariya" name="author">
<link href="../favicon.png" rel="icon" type="image/png">
<link href="../stylesheets/base.css" media="screen" rel="stylesheet" type="text/css">
<link href="../stylesheets/orange.css" media="screen" rel="stylesheet" type="text/css">
<link href="../stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css">
<link href="../entries.rss" rel="alternate" title="RSS" type="application/rss+xml">
<link href="http://coderwall.com/stylesheets/jquery.coderwall.css" media="all" rel="stylesheet" type="text/css">
<script src="../javascripts/jquery.js"></script><script src="http://coderwall.com/javascripts/jquery.coderwall.js"></script>
</head>
<body>
<header id="header"><h1>
<a href="../index.html">Joy Luck Crab</a>
</h1>
<nav><ul id="menu">
<li>
<a href="../index.html">Home</a>
</li>
<li>
<a href="../profile.html">Profile</a>
</li>
<li>
<a href="../entries.html">Archives</a>
</li>
<li>
<a href="../entries.rss" target="_blank">RSS</a>
</li>
</ul></nav></header><div id="page">
<div id="content">
<article class="article autopagerize_page_element"><h1 class="date">
<a href="../entries/20120321.html">2012-03-21</a>
</h1>
<h1 id="a0">
<a href="../entries/20120321/a0.html">Rubyで日付っぽい文字列を日時や日付に変換するときのこと</a>
</h1>
<p>　<a href="https://github.com/mojombo/chronic">Chronic</a>べんり。別に最近のものでもないのだけど、しらなかった。</p>
<p>　それまではActiveSupportで頑張っていた。</p>
<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'active_support/core_ext/object'</span>
<span class="nb">require</span> <span class="s1">'date'</span>

<span class="k">def</span> <span class="nf">parse_date_str</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">date_str</span>
  <span class="k">when</span> <span class="sr">/^yesterday$/i</span> <span class="k">then</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span>
  <span class="k">when</span> <span class="sr">/^today$/i</span>     <span class="k">then</span> <span class="mi">0</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span>
  <span class="k">when</span> <span class="sr">/^tomorrow$/i</span>  <span class="k">then</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">since</span>
  <span class="k">when</span> <span class="sr">/^[0-9]+[\.\s](?:days?|weeks?|months?|years?)[\.\s](?:ago|since)$/i</span>
    <span class="nb">eval</span><span class="p">(</span><span class="n">date_str</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s1">'.'</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
  <span class="k">end</span><span class="o">.</span><span class="n">to_date</span>
<span class="k">end</span>

<span class="n">parse_date_str</span> <span class="s1">'20110101'</span>   <span class="c1"># =&gt; Sat, 01 Jan 2011</span>
<span class="n">parse_date_str</span> <span class="s1">'yesterday'</span>  <span class="c1"># =&gt; Tue, 20 Mar 2012</span>
<span class="n">parse_date_str</span> <span class="s1">'1 week ago'</span> <span class="c1"># =&gt; Wed, 14 Mar 2012</span>
</pre>
</div>
<p>　こんなコード書かなくてもよかったんだ！</p>
<div class="highlight">
<pre><span class="nb">require</span> <span class="s1">'date'</span>
<span class="nb">require</span> <span class="s1">'chronic'</span>

<span class="k">def</span> <span class="nf">parse_date_str</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span>
  <span class="p">(</span><span class="no">Chronic</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_str</span><span class="p">)</span> <span class="o">||</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_str</span><span class="p">))</span><span class="o">.</span><span class="n">to_date</span>
<span class="k">end</span>

<span class="n">parse_date_str</span> <span class="s1">'20110101'</span>   <span class="c1"># =&gt; #&lt;Date: 2011-01-01 ((2455563j,0s,0n),+0s,2299161j)&gt;</span>
<span class="n">parse_date_str</span> <span class="s1">'yesterday'</span>  <span class="c1"># =&gt; #&lt;Date: 2012-03-20 ((2456007j,0s,0n),+0s,2299161j)&gt;</span>
<span class="n">parse_date_str</span> <span class="s1">'1 week ago'</span> <span class="c1"># =&gt; #&lt;Date: 2012-03-14 ((2456001j,0s,0n),+0s,2299161j)&gt;</span>
</pre>
</div>
<p>　Chronicはparseできなかったときはnilを返す。
Date.parseを残しているのは、YYYYMMDDみたいな形式も使いたかったからで、それを除けばだいたいChronicだけで充分だった。</p>
<p>　戻り値の見た目（Date#inspect）が違うのはActiveSupportの拡張っぽい。</p>
</article><div class="nav">
<div class="prev">
<link href="../entries/20120323.html" rel="prev">
</div>
<div class="next">
<link href="../entries/20120317.html" rel="next">
</div>
</div>
<div class="autopagerize_insert_before"></div>
</div>
<aside id="sidebar"><h3>Author</h3>
<div class="author">
<a href="../profile.html">hibariya</a>
</div>
<h3>Recent entries</h3>
<div class="recent-entries">
<ul>
<li>
<a href="../entries/20120602/a0.html">社内で code についての発表をした</a>
</li>
<li>
<a href="../entries/20120505/a0.html">cline-0.3.0</a>
</li>
<li>
<a href="../entries/20120411/a0.html">標準添付ライブラリもエディタで開けるreditorを作った</a>
</li>
<li>
<a href="../entries/20120329/a0.html">所在の分からないWARNINGが出力されるときのこと</a>
</li>
<li>
<a href="../entries/20120328/a0.html">記号がうまく入力できない</a>
</li>
<li>
<a href="../entries/20120326/a0.html">プロセスをforkするときのこと</a>
</li>
</ul>
<div class="archives">
<a href="../entries.html">Archives</a>
</div>
</div>
<h3>Coderwall</h3>
<section class="coderwall" data-coderwall-orientation="horizontal" data-coderwall-username="hibariya"></section></aside>
</div>
<footer id="footer">
Joy Luck Crab (C) hibariya
Generated by
<a href="https://github.com/hibariya/retter" target="_blank">Retter</a>
</footer>
</body>
</html>

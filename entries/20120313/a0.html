<!DOCTYPE html>
<html>
  <head>
    <title>FiberとSemi-Coroutine - Hibariya</title>
    <meta charset='utf-8'>
    <meta content='hibariya' name='author'>
    <link href='/favicon-f5e12bf5.png' rel='icon' type='image/png'>
    <link href='/articles.xml' rel='alternate' title='Atom' type='application/atom+xml'>
    <link href="../../stylesheets/application-458a848e.css" rel="stylesheet" type="text/css" media="all" />
    <script src="../../javascripts/application-5ad96b48.js" type="text/javascript"></script>
    <link href='http://note.hibariya.org/articles/20120313/a0.html' rel='canonical'>
  </head>
  <body class='articles articles_20120313 articles_20120313_a0'>
    <header>
      <h1>
        <a href="/">Hibariya</a>
      </h1>
      <nav>
        <ul id='menu'>
          <li><a href="/">Home</a></li>
          <li><a href="../../articles.html">Articles</a></li>
          <li><a target="_blank" href="https://github.com/hibariya">Github</a></li>
          <li><a target="_blank" href="https://twitter.com/hibariya">Twitter</a></li>
          <li><a target="_blank" href="https://hibariya.org">hibariya.org</a></li>
        </ul>
      </nav>
    </header>
    <main>
      <article>
        <time>2012-03-13</time>
        <h1><a href="a0.html">FiberとSemi-Coroutine</a></h1>
        <p>やっと使い方を覚えたFiberについての覚書。組込みライブラリ編。</p>
        
        <h2>Fiber</h2>
        
        <p>Rubyの組込みライブラリとして提供されているFiber。
        ノンプリエンプティブな軽量スレッド。</p>
        
        <ul>
        <li>生成したファイバは勝手には走らない</li>
        <li>コンテキストの切り替えは自分で</li>
        <li>親から子へ、子から親へ切り替えることができる</li>
        <li>IO待ちでも切り替わらない</li>
        </ul>
        
        <p>コンテキストの切り替えは<code>Fiber#resume</code>と<code>Fiber.yield</code>で行う。</p>
        <pre class="highlight ruby"><code><span class="n">fiber</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>&#x000A;  <span class="nb">puts</span> <span class="s1">'Hello Alice.'</span>&#x000A;&#x000A;  <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span>&#x000A;&#x000A;  <span class="nb">puts</span> <span class="s1">'Hello Bob.'</span>&#x000A;&#x000A;  <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span>&#x000A;&#x000A;  <span class="nb">puts</span> <span class="s1">'Hello Carol.'</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="n">fiber</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># "Hello Alice." と表示</span>&#x000A;<span class="n">fiber</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># "Hello Bob." と表示</span>&#x000A;<span class="n">fiber</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># "Hello Carol." と表示</span>&#x000A;</code></pre>
        
        <p>上の例ではトップレベルが親。ブロックの中が子。親と子でキャッチボールしてる感じ。
        <code>Fiber#resume</code>で親から子へコンテキストを切り替え、<code>Fiber.yield</code>で子から親へ切り替える。</p>
        
        <p>組込みライブラリとしてのFiberは、親から子、子から親へのみ切り替えられる（それ以外のコンテキストに切り替えることはできない）。</p>
        
        <h2>Fiberの引数と戻り値</h2>
        
        <h3>親からみたときの引数と戻り値</h3>
        
        <p>引数は常に<code>Fiber#resume</code>に渡す。
        戻り値は<code>Fiber#resume</code>の戻り値。</p>
        
        <h3>子からみたときの引数と戻り値</h3>
        
        <p>最初の引数はブロック引数として渡される。
        それ以降の引数は<code>Fiber.yield</code>の戻り値として与えられる。</p>
        
        <p>戻り値は<code>Fiber.yield</code>の引数として渡す。
        <code>Fiber.new</code>で渡したブロックが終了したときは、最後に評価された式の値が戻り値として返る。</p>
        <pre class="highlight ruby"><code><span class="n">greet3</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="o">|</span>&#x000A;  <span class="mi">3</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span>&#x000A;    <span class="nb">name</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="s2">"Hi </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="s1">'Good night'</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="n">greet3</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="s1">'Aron'</span><span class="p">)</span>  <span class="c1"># =&gt; "Hi Aron"</span>&#x000A;<span class="n">greet3</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="s1">'Billy'</span><span class="p">)</span> <span class="c1"># =&gt; "Hi Billy"</span>&#x000A;<span class="n">greet3</span><span class="p">.</span><span class="nf">resume</span><span class="p">(</span><span class="s1">'Colon'</span><span class="p">)</span> <span class="c1"># =&gt; "Hi Colon"</span>&#x000A;<span class="n">greet3</span><span class="p">.</span><span class="nf">resume</span>          <span class="c1"># =&gt; "Good night"</span>&#x000A;</code></pre>
        
        <h2>Coroutine</h2>
        
        <ul>
        <li>途中まで計算して、一旦値を返して、その後また続きから実行できる仕組み</li>
        <li>親と子（callerとcallee）という関係があるものをsemi-coroutineと呼ぶ</li>
        <li>組込みライブラリのFiberはsemi-coroutineの実装と言ってよいのかな</li>
        </ul>
        
        <h2>semi-coroutineさん何に使うの</h2>
        
        <p>ジェネレータや外部イテレータに使うらしい。
        無限リストにも使うらしい。
        外部イテレータとしてときどき使うかもしれないEnumeratorではFiberを使ってるようだ。</p>
        
        <p>永遠に終わらない数字のカウントアップを行うジェネレータ。</p>
        <pre class="highlight ruby"><code><span class="n">endless</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>&#x000A;  <span class="kp">loop</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>&#x000A;    <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="p">}</span>&#x000A;&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 0</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 1</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 2</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 3</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 4</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 5</span>&#x000A;<span class="n">endless</span><span class="p">.</span><span class="nf">resume</span> <span class="c1"># =&gt; 6</span>&#x000A;<span class="c1"># endless...</span>&#x000A;</code></pre>
        
        <p>FiberのAPIを隠して外部イテレータっぽく使ってみる。</p>
        <pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">EndlessNumber</span>&#x000A;  <span class="k">def</span> <span class="nf">initialize</span>&#x000A;    <span class="n">rewind</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="nf">rewind</span>&#x000A;    <span class="vi">@generator</span> <span class="o">=</span> <span class="no">Fiber</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span>&#x000A;      <span class="kp">loop</span><span class="p">.</span><span class="nf">with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>&#x000A;        <span class="no">Fiber</span><span class="p">.</span><span class="nf">yield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>&#x000A;      <span class="k">end</span>&#x000A;    <span class="p">}</span>&#x000A;&#x000A;    <span class="nb">self</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="k">def</span> <span class="nf">next</span>&#x000A;    <span class="vi">@generator</span><span class="p">.</span><span class="nf">resume</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="n">en</span> <span class="o">=</span> <span class="no">EndlessNumber</span><span class="p">.</span><span class="nf">new</span>&#x000A;&#x000A;<span class="n">en</span><span class="p">.</span><span class="nf">next</span> <span class="c1"># =&gt; 0</span>&#x000A;<span class="n">en</span><span class="p">.</span><span class="nf">next</span> <span class="c1"># =&gt; 1</span>&#x000A;<span class="n">en</span><span class="p">.</span><span class="nf">next</span> <span class="c1"># =&gt; 2</span>&#x000A;<span class="n">en</span><span class="p">.</span><span class="nf">rewind</span>&#x000A;<span class="n">en</span><span class="p">.</span><span class="nf">next</span> <span class="c1"># =&gt; 0</span>&#x000A;&#x000A;<span class="k">while</span> <span class="n">num</span> <span class="o">=</span> <span class="n">en</span><span class="p">.</span><span class="nf">next</span>&#x000A;  <span class="nb">puts</span> <span class="n">num</span>&#x000A;<span class="k">end</span> <span class="c1"># ウワーッ</span>&#x000A;</code></pre>
        
        <p>　これに使おう、というのがとっさに思い浮かばない。</p>
      </article>
      <div id='comments'>
        <div id="disqus_thread"></div>
        <script>
          /* * * CONFIGURATION VARIABLES * * */
          var disqus_shortname = 'note-hibariya-org';
          
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
        </script>
      </div>
    </main>
  </body>
</html>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  
  ga('create', 'UA-64572851-1', 'auto');
  ga('send', 'pageview');
</script>

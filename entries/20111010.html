<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>2011-10-10 - Joy Luck Crab</title>
<meta charset="utf-8" content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta content="hibariya" name="author">
<link href="../favicon.png" rel="icon" type="image/png">
<link href="../stylesheets/base.css" media="screen" rel="stylesheet" type="text/css">
<link href="../stylesheets/orange.css" media="screen" rel="stylesheet" type="text/css">
<link href="../stylesheets/pygments.css" media="screen" rel="stylesheet" type="text/css">
<link href="../entries.rss" rel="alternate" title="RSS" type="application/rss+xml">
<link href="http://coderwall.com/stylesheets/jquery.coderwall.css" media="all" rel="stylesheet" type="text/css">
<script src="../javascripts/jquery.js"></script><script src="http://coderwall.com/javascripts/jquery.coderwall.js"></script>
</head>
<body>
<header id="header"><h1>
<a href="../index.html">Joy Luck Crab</a>
</h1>
<nav><ul id="menu">
<li>
<a href="../index.html">Home</a>
</li>
<li>
<a href="../profile.html">Profile</a>
</li>
<li>
<a href="../entries.html">Archives</a>
</li>
<li>
<a href="../entries.rss" target="_blank">RSS</a>
</li>
</ul></nav></header><div id="page">
<div id="content">
<article class="article autopagerize_page_element"><h1 class="date">
<a href="../entries/20111010.html">2011-10-10</a>
</h1>
<h1 id="a0">
<a href="../entries/20111010/a0.html">Rubyのトップレベルについて整理する</a>
</h1>
<p>トップレベルでメソッドを定義したとき、なぜそれがいきなり使えるようになるのかを説明できなかったので調べたり人にきいたりした。</p>
<h2>メソッドについての理解（インスタンスメソッド）</h2>
<p>クラス定義式の中で（特異メソッドでない）メソッドを定義すると、メソッドはそのクラスのインスタンスメソッドメソッドになる。</p>
<div class="highlight">
<pre>  <span class="k">class</span> <span class="nc">Foo</span>
    <span class="k">def</span> <span class="nf">bar</span>
      <span class="s1">'bar'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">Foo</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">bar</span> <span class="c1"># =&gt; "bar"</span>
</pre>
</div>
<p>同じような方法でトップレベルにメソッドを定義すると、なぜかその場で使えるようになる。</p>
<div class="highlight">
<pre><span class="k">def</span> <span class="nf">bar</span>
  <span class="s1">'bar'</span>
<span class="k">end</span>

<span class="n">bar</span> <span class="c1"># =&gt; "bar"</span>
</pre>
</div>
<p>もちろん、同じようなことはクラス定義式内ではできない。</p>
<div class="highlight">
<pre>  <span class="k">class</span> <span class="nc">Foo</span>
    <span class="k">def</span> <span class="nf">baz</span>
      <span class="s1">'baz'</span>
    <span class="k">end</span>

    <span class="n">baz</span>
  <span class="k">end</span> <span class="c1"># =&gt; NameError: undefined local variable or method...</span>
</pre>
</div>
<p>どうやらクラス定義式の中とトップレベルでは、同じようにメソッド定義式を書いても少し動きが違ってくるらしい。</p>
<h2>トップレベルで定義されたメソッドは何処へ</h2>
<p>トップレベルで定義したメソッドについて色々と調べた結果をまとめて書きます。</p>
<p>クラス定義式の中に書いたメソッドはそのクラスのインスタンスメソッドになった。じゃあトップレベルに定義されたメソッドは何処へ。
実はObjectの（privateな）メソッドになっていた。そしてトップレベルはObjectのインスタンスなので、トップレベルにメソッドを定義すると即座に使えるようになるということらしい。</p>
<div class="highlight">
<pre>  <span class="k">def</span> <span class="nf">carol</span><span class="p">;</span> <span class="k">end</span>

  <span class="no">Object</span><span class="o">.</span><span class="n">private_instance_methods</span><span class="o">.</span><span class="n">grep</span> <span class="sr">/carol/</span> <span class="c1"># =&gt; [:carol]</span>
  <span class="no">Object</span><span class="o">.</span><span class="n">private_methods</span><span class="o">.</span><span class="n">grep</span> <span class="sr">/carol/</span>          <span class="c1"># =&gt; [:carol]</span>
</pre>
</div>
<p>トップレベルで定義したメソッドがどうしてすぐに呼べるのか、言葉のうえでは結論が出た感じになってしまったけれど、話はもう少しだけ続く。</p>
<h2>Objectの不思議と関数っぽさ</h2>
<p>Objectに定義されたメソッドは他のクラスに定義されたメソッドとは少し違う動きをする。
なんと、Objectに定義されたメソッドはObjectのクラスメソッドとしても定義される。しかもクラスメソッドにはprivateとかの呼び出し制限もそのまま引き継がれる。</p>
<div class="highlight">
<pre>  <span class="k">class</span> <span class="nc">Object</span>
    <span class="k">def</span> <span class="nf">bob</span>
      <span class="s1">'ボブですよ'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="no">Object</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">bob</span> <span class="c1"># =&gt; "ボブですよ"</span>
  <span class="no">Object</span><span class="o">.</span><span class="n">bob</span>     <span class="c1"># =&gt; "ボブですよ"</span>
  <span class="n">bob</span>            <span class="c1"># =&gt; "ボブですよ"</span>
</pre>
</div>
<p>なぜだろう。なぜならObjectはClassのインスタンスだけど、同時にObject（のサブクラス）のインスタンスでもあるから、らしい。
堂々巡りで混乱してくる。</p>
<div class="highlight">
<pre>  <span class="no">Object</span><span class="o">.</span><span class="n">class</span>           <span class="c1"># =&gt; Class</span>
  <span class="no">Object</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">ancestors</span> <span class="c1"># =&gt; [Class, Module, Object, Kernel, BasicObject]</span>
  <span class="no">Object</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Object</span><span class="p">)</span>   <span class="c1"># =&gt; true</span>
</pre>
</div>
<p>でもこの振舞いのおかげで、トップレベルに定義したメソッドはどこでも使えるようになる。何処に居ようがselfの祖先はObjectだから。</p>
<p>こんなふうに。</p>
<div class="highlight">
<pre>  <span class="k">def</span> <span class="nf">alice</span>
    <span class="nb">puts</span> <span class="s1">'hi'</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="n">alice</span> <span class="c1"># "hi"と表示</span>

    <span class="k">def</span> <span class="nf">foo</span>
      <span class="n">alice</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">foo</span>
      <span class="n">alice</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">BarBar</span>
    <span class="n">alice</span> <span class="c1"># "hi"と表示</span>
  <span class="k">end</span>

  <span class="no">Bar</span><span class="o">.</span><span class="n">foo</span>     <span class="c1"># "hi"と表示</span>
  <span class="no">Bar</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># "hi"と表示</span>

  <span class="n">alice</span>       <span class="c1"># "hi"と表示</span>
</pre>
</div>
<p>もちろん、Object.#aliceはprivateメソッドなので、<code>self.alice</code>とか<code>Object.alice</code>と書くと例外NoMethodErrorが発生する。
レシーバを記述しない関数風の呼び方が強く奨められているのは、モジュール関数と同じく、関数っぽい使い方をすることが想定されているからなのでしょうね。</p>
</article><div class="nav">
<div class="prev">
<link href="../entries/20111012.html" rel="prev">
</div>
<div class="next">
<link href="../entries/20111003.html" rel="next">
</div>
</div>
<div class="autopagerize_insert_before"></div>
</div>
<aside id="sidebar"><h3>Author</h3>
<div class="author">
<a href="../profile.html">hibariya</a>
</div>
<h3>Recent entries</h3>
<div class="recent-entries">
<ul>
<li>
<a href="../entries/20120601/a0.html">こんにちはこんにちは!</a>
</li>
<li>
<a href="../entries/20120505/a0.html">cline-0.3.0</a>
</li>
<li>
<a href="../entries/20120411/a0.html">標準添付ライブラリもエディタで開けるreditorを作った</a>
</li>
<li>
<a href="../entries/20120329/a0.html">所在の分からないWARNINGが出力されるときのこと</a>
</li>
<li>
<a href="../entries/20120328/a0.html">記号がうまく入力できない</a>
</li>
<li>
<a href="../entries/20120326/a0.html">プロセスをforkするときのこと</a>
</li>
</ul>
<div class="archives">
<a href="../entries.html">Archives</a>
</div>
</div>
<h3>Coderwall</h3>
<section class="coderwall" data-coderwall-orientation="horizontal" data-coderwall-username="hibariya"></section></aside>
</div>
<footer id="footer">
Joy Luck Crab (C) hibariya
Generated by
<a href="https://github.com/hibariya/retter" target="_blank">Retter</a>
</footer>
</body>
</html>
